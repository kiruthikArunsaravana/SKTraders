/**
 * @fileOverview Firestore Security Rules for SK Traders.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model. Users can only access data based on their role.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the userId as the document ID.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sale transactions.
 * - /purchases/{purchaseId}: Stores purchase transactions.
 * - /receipts/{receiptId}: Stores receipt information.
 * - /expenses/{expenseId}: Stores expense records.
 * - /exports/{exportId}: Stores export order details.
 * - /local_sales/{localSaleId}: Stores local sale order details.
 * - /financial_transactions/{transactionId}: Stores financial transactions.
 *
 * Key Security Decisions:
 * - Users collection is protected using the "Ownership" pattern and the role can only be set during user creation.
 * - All other collections are open for read to everyone but only accessible for admin users on writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user profiles. Only the user themselves can read/write their profile.
     * @path /users/{userId}
     * @allow (create) User with ID matching auth.uid can create their profile.
     * @deny (create) User tries to create a profile with an ID that doesn't match their auth.uid.
     * @allow (get, list) User can read their own profile.
     * @deny (get, list) User tries to read someone else's profile.
     * @allow (update, delete) User can update their own profile.
     * @deny (update, delete) User tries to update someone else's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read client information, but only admins can modify it.
     * @path /clients/{clientId}
     * @allow (get, list) Any user can read client information.
     * @allow (create, update, delete) Only admins can create, update, or delete client information.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete client information.
     * @principle Public read, admin-only writes.
     */
    match /clients/{clientId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read product information, but only admins can modify it.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product information.
     * @allow (create, update, delete) Only admins can create, update, or delete product information.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete product information.
     * @principle Public read, admin-only writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read stock information, but only admins can modify it.
     * @path /stocks/{stockId}
     * @allow (get, list) Any user can read stock information.
     * @allow (create, update, delete) Only admins can create, update, or delete stock information.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete stock information.
     * @principle Public read, admin-only writes.
     */
    match /stocks/{stockId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read sale transactions, but only admins can modify them.
     * @path /sales/{saleId}
     * @allow (get, list) Any user can read sale transactions.
     * @allow (create, update, delete) Only admins can create, update, or delete sale transactions.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete sale transactions.
     * @principle Public read, admin-only writes.
     */
    match /sales/{saleId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read purchase transactions, but only admins can modify them.
     * @path /purchases/{purchaseId}
     * @allow (get, list) Any user can read purchase transactions.
     * @allow (create, update, delete) Only admins can create, update, or delete purchase transactions.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete purchase transactions.
     * @principle Public read, admin-only writes.
     */
    match /purchases/{purchaseId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read receipt information, but only admins can modify it.
     * @path /receipts/{receiptId}
     * @allow (get, list) Any user can read receipt information.
     * @allow (create, update, delete) Only admins can create, update, or delete receipt information.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete receipt information.
     * @principle Public read, admin-only writes.
     */
    match /receipts/{receiptId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read expense records, but only admins can modify them.
     * @path /expenses/{expenseId}
     * @allow (get, list) Any user can read expense records.
     * @allow (create, update, delete) Only admins can create, update, or delete expense records.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete expense records.
     * @principle Public read, admin-only writes.
     */
    match /expenses/{expenseId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

     /**
     * @description Allows anyone to read export order details, but only admins can modify them.
     * @path /exports/{exportId}
     * @allow (get, list) Any user can read export order details.
     * @allow (create, update, delete) Only admins can create, update, or delete export order details.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete export order details.
     * @principle Public read, admin-only writes.
     */
    match /exports/{exportId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read local sale order details, but only admins can modify them.
     * @path /local_sales/{localSaleId}
     * @allow (get, list) Any user can read local sale order details.
     * @allow (create, update, delete) Only admins can create, update, or delete local sale order details.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete local sale order details.
     * @principle Public read, admin-only writes.
     */
    match /local_sales/{localSaleId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read financial transaction details, but only admins can modify them.
     * @path /financial_transactions/{transactionId}
     * @allow (get, list) Any user can read financial transaction details.
     * @allow (create, update, delete) Only admins can create, update, or delete financial transaction details.
     * @deny (create, update, delete) Non-admins cannot create, update, or delete financial transaction details.
     * @principle Public read, admin-only writes.
     */
    match /financial_transactions/{transactionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}