/**
 * @fileoverview Firestore Security Rules for SK Traders.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model where users are assigned roles (Admin, Manager, Employee).
 * Access to collections is determined by the user's role, with Admins having the broadest access.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the 'role' field being crucial for authorization.
 * - Top-level collections: All other collections store various business entities (clients, products, sales, etc.).
 *
 * Key Security Decisions:
 * - No user listing: Listing all user accounts is disallowed to prevent unauthorized discovery.
 * - Role-Based Access: Access to data is governed by user roles.
 * - Explicit Denials: Permissions are explicitly denied where not granted to ensure a secure-by-default posture.
 *
 * Denormalization for Authorization:
 * - The /users/{userId} document includes a denormalized `role` field, avoiding the need for separate role lookup.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user's ID matches the requested user ID.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user exists and is the owner.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user exists and is the owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Checks if the user has the Admin role.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    /**
     * @description Checks if the user has the Manager role.
     * @return {boolean} True if the user is a manager, false otherwise.
     */
    function isManager() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Manager';
    }

    /**
     * @description Checks if the user has the Employee role.
     * @return {boolean} True if the user is an employee, false otherwise.
     */
    function isEmployee() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Employee';
    }

    /**
     * @description Rules for user profiles. Only the user themselves can read/write their profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123 if request.auth.uid == 'user123'.
     * @deny (create) - User with UID 'user123' cannot create a profile at /users/user456.
     * @allow (get, update, delete) - User with UID 'user123' can get, update, and delete their profile at /users/user123.
     * @deny (get, update, delete) - User with UID 'user123' cannot get, update, or delete the profile at /users/user456.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for clients. Admins, Managers, and Employees can read client data. Admins and Managers can create, update, and delete.
     * @path /clients/{clientId}
     * @allow (get, list) - Any signed-in user can read client data.
     * @allow (create) - Admins and Managers can create client data.
     * @allow (update, delete) - Admins and Managers can update and delete client data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete client data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for products. Admins, Managers, and Employees can read product data. Only Admins and Managers can create, update, and delete.
     * @path /products/{productId}
     * @allow (get, list) - Any signed-in user can read product data.
     * @allow (create) - Admins and Managers can create product data.
     * @allow (update, delete) - Admins and Managers can update and delete product data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete product data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for stock. Admins, Managers, and Employees can read stock data. Only Admins and Managers can create, update, and delete.
     * @path /stocks/{stockId}
     * @allow (get, list) - Any signed-in user can read stock data.
     * @allow (create) - Admins and Managers can create stock data.
     * @allow (update, delete) - Admins and Managers can update and delete stock data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete stock data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for sales. Admins, Managers, and Employees can read sale data. Only Admins and Managers can create, update, and delete.
     * @path /sales/{saleId}
     * @allow (get, list) - Any signed-in user can read sale data.
     * @allow (create) - Admins and Managers can create sale data.
     * @allow (update, delete) - Admins and Managers can update and delete sale data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete sale data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for purchases. Admins, Managers, and Employees can read purchase data. Only Admins and Managers can create, update, and delete.
     * @path /purchases/{purchaseId}
     * @allow (get, list) - Any signed-in user can read purchase data.
     * @allow (create) - Admins and Managers can create purchase data.
     * @allow (update, delete) - Admins and Managers can update and delete purchase data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete purchase data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for receipts. Admins, Managers, and Employees can read receipt data. Only Admins and Managers can create, update, and delete.
     * @path /receipts/{receiptId}
     * @allow (get, list) - Any signed-in user can read receipt data.
     * @allow (create) - Admins and Managers can create receipt data.
     * @allow (update, delete) - Admins and Managers can update and delete receipt data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete receipt data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for expenses. Admins, Managers, and Employees can read expense data. Only Admins and Managers can create, update, and delete.
     * @path /expenses/{expenseId}
     * @allow (get, list) - Any signed-in user can read expense data.
     * @allow (create) - Admins and Managers can create expense data.
     * @allow (update, delete) - Admins and Managers can update and delete expense data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete expense data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for exports. Admins, Managers, and Employees can read export data. Only Admins and Managers can create, update, and delete.
     * @path /exports/{exportId}
     * @allow (get, list) - Any signed-in user can read export data.
     * @allow (create) - Admins and Managers can create export data.
     * @allow (update, delete) - Admins and Managers can update and delete export data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete export data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

   /**
     * @description Rules for local sales. Admins, Managers, and Employees can read local sale data. Only Admins and Managers can create, update, and delete.
     * @path /local_sales/{localSaleId}
     * @allow (get, list) - Any signed-in user can read local sale data.
     * @allow (create) - Admins and Managers can create local sale data.
     * @allow (update, delete) - Admins and Managers can update and delete local sale data.
     * @deny (create, update, delete) - Employees cannot create, update, or delete local sale data.
     * @principle Restricts write access to Admins and Managers.
     */
    match /local_sales/{localSaleId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Rules for financial transactions. Admins and Managers can read, create, update, and delete financial transaction data. Employees cannot access this data.
     * @path /financial_transactions/{transactionId}
     * @allow (get, list) - Admins and Managers can read financial transaction data.
     * @allow (create) - Admins and Managers can create financial transaction data.
     * @allow (update, delete) - Admins and Managers can update and delete financial transaction data.
     * @deny (get, list, create, update, delete) - Employees cannot access financial transaction data.
     * @principle Restricts access to financial data to Admins and Managers.
     */
    match /financial_transactions/{transactionId} {
      allow get, list: if isAdmin() || isManager();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }
  }
}