/**
 * @fileoverview Firestore Security Rules for SK Traders Application
 *
 * Core Philosophy:
 * This ruleset prioritizes secure access to data based on a combination of
 * ownership and public read access where appropriate. It aims to prevent
 * unauthorized data modification and exposure while allowing for rapid
 * prototyping. Data validation is minimized to enable flexible data shapes
 * during development.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data. Access is restricted to the
 *   owning user.
 * - /clients/{clientId}: Stores client data. Public read, owner-only write access.
 * - /products/{productId}: Stores product data. Public read, owner-only write access.
 * - /financial_transactions/{transactionId}: Stores financial transaction data. Public read, owner-only write access.
 * - /exports/{exportId}: Stores export order data. Public read, owner-only write access.
 * - /local_sales/{saleId}: Stores local sale data. Public read, owner-only write access.
 * - /coconut_purchases/{purchaseId}: Stores coconut purchase records. Public read, owner-only write access.
 *
 * Key Security Decisions:
 * - User listing is disabled to prevent data harvesting.
 * - Public read access is enabled for the 'clients', 'products', 'financial_transactions',
 *   'exports', 'local_sales' and 'coconut_purchases' collections to support open data display. However, write
 *   access is strictly controlled to prevent unauthorized modifications.
 * - To simplify rules and improve performance, data required for authorization (e.g.,
 *   ownership) should be denormalized directly onto the documents being secured.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can access their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile.
     * @allow (get, list, update, delete) - Authenticated user accesses their own profile.
     * @deny (create) - Authenticated user attempts to create a profile with a different userId.
     * @deny (get, list, update, delete) - Authenticated user attempts to access another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to client data, but restricts write access to authenticated users who are the owners.
     * @path /clients/{clientId}
     * @allow (get, list) - Any user can read client data.
     * @allow (create) - Authenticated user can create a client, ensuring the user ID matches the expected owner field.
     * @allow (update, delete) - Authenticated user can modify/delete a client only if they are the owner and the document exists.
     * @deny (create) - Unauthenticated user attempts to create a client or the userId field does not match the authenticated user.
     * @deny (update, delete) - Unauthenticated user attempts to modify/delete a client or the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows public read access to product data, but restricts write access to authenticated users who are the owners.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read product data.
     * @allow (create) - Authenticated user can create a product, ensuring the user ID matches the expected owner field.
     * @allow (update, delete) - Authenticated user can modify/delete a product only if they are the owner and the document exists.
     * @deny (create) - Unauthenticated user attempts to create a product or the userId field does not match the authenticated user.
     * @deny (update, delete) - Unauthenticated user attempts to modify/delete a product or the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows public read access to financial transaction data, but restricts write access to authenticated users who are the owners.
     * @path /financial_transactions/{transactionId}
     * @allow (get, list) - Any user can read financial transaction data.
     * @allow (create) - Authenticated user can create a transaction, ensuring the user ID matches the expected owner field.
     * @allow (update, delete) - Authenticated user can modify/delete a transaction only if they are the owner and the document exists.
     * @deny (create) - Unauthenticated user attempts to create a transaction or the userId field does not match the authenticated user.
     * @deny (update, delete) - Unauthenticated user attempts to modify/delete a transaction or the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /financial_transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows public read access to export data, but restricts write access to authenticated users who are the owners.
     * @path /exports/{exportId}
     * @allow (get, list) - Any user can read export data.
     * @allow (create) - Authenticated user can create a export, ensuring the user ID matches the expected owner field.
     * @allow (update, delete) - Authenticated user can modify/delete a export only if they are the owner and the document exists.
     * @deny (create) - Unauthenticated user attempts to create a export or the userId field does not match the authenticated user.
     * @deny (update, delete) - Unauthenticated user attempts to modify/delete a export or the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /exports/{exportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows public read access to local sale data, but restricts write access to authenticated users who are the owners.
     * @path /local_sales/{saleId}
     * @allow (get, list) - Any user can read local sale data.
     * @allow (create) - Authenticated user can create a local sale, ensuring the user ID matches the expected owner field.
     * @allow (update, delete) - Authenticated user can modify/delete a local sale only if they are the owner and the document exists.
     * @deny (create) - Unauthenticated user attempts to create a local sale or the userId field does not match the authenticated user.
     * @deny (update, delete) - Unauthenticated user attempts to modify/delete a local sale or the user is not the owner.
     * @principle Public read access with owner-only writes.
     */
    match /local_sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read, write: if isSignedIn();
    }
    
    /**
     * @description Allows public read access to coconut purchase data, but restricts write access to authenticated users.
     * @path /coconut_purchases/{purchaseId}
     * @allow (read, write) - Any authenticated user can read and write coconut purchase data.
     * @principle Public read access with owner-only writes.
     */
    match /coconut_purchases/{purchaseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read, write: if isSignedIn();
    }
  }
}