/**
 * @fileoverview Firestore Security Rules for HuskTrack application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, granting specific
 * permissions based on the user's role (Admin, Manager, Employee) and the
 * ownership of data. User data is protected under `/users/{userId}`, while
 * application-wide data resides in top-level collections.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the 'role' field denormalized for
 *   authorization purposes.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product details.
 * - /stocks/{stockId}: Stores stock levels for products.
 * - /sales/{saleId}: Records sale transactions.
 * - /purchases/{purchaseId}: Tracks purchase transactions.
 * - /receipts/{receiptId}: Stores receipt information for sales or purchases.
 * - /expenses/{expenseId}: Details expense records.
 * - /exports/{exportId}: Manages export order details.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data under /users/{userId}.
 * - Listing of users is disallowed to prevent unauthorized enumeration.
 * - Data validation focuses on authorization and relational integrity, omitting
 *   strict schema enforcement for rapid prototyping.
 * - All write operations are strictly controlled based on user roles and
 *   document ownership, preventing unauthorized modifications.
 *
 * Denormalization for Authorization:
 * - User roles are stored directly within the `/users/{userId}` document to
 *   avoid costly `get()` calls during authorization checks.
 *
 * Structural Segregation:
 * - User-specific data is stored under `/users/{userId}`, while application-wide
 *   data resides in top-level collections. This simplifies security rules and
 *   improves performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Manages user profiles, allowing users to read and write their own data.
     * @path: /users/{userId}
     * @allow: (create) - Authenticated user creates their profile with matching userId.
     * @allow: (get, update, delete) - Authenticated user with matching userId accesses their profile.
     * @deny: (create) - Authenticated user attempts to create a profile with a mismatched userId.
     * @principle: Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in and owns the document.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description: Manages client information. Only authenticated users can manage clients.
     * @path: /clients/{clientId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage clients.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage clients.
     * @principle: Restricts client management to authenticated users.
     */
    match /clients/{clientId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages product information. Only authenticated users can manage products.
     * @path: /products/{productId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage products.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage products.
     * @principle: Restricts product management to authenticated users.
     */
    match /products/{productId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages stock information. Only authenticated users can manage stock.
     * @path: /stocks/{stockId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage stock.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage stock.
     * @principle: Restricts stock management to authenticated users.
     */
    match /stocks/{stockId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages sale transactions. Only authenticated users can manage sales.
     * @path: /sales/{saleId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage sales.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage sales.
     * @principle: Restricts sale management to authenticated users.
     */
    match /sales/{saleId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages purchase transactions. Only authenticated users can manage purchases.
     * @path: /purchases/{purchaseId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage purchases.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage purchases.
     * @principle: Restricts purchase management to authenticated users.
     */
    match /purchases/{purchaseId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages receipts. Only authenticated users can manage receipts.
     * @path: /receipts/{receiptId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage receipts.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage receipts.
     * @principle: Restricts receipt management to authenticated users.
     */
    match /receipts/{receiptId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages expenses. Only authenticated users can manage expenses.
     * @path: /expenses/{expenseId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage expenses.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage expenses.
     * @principle: Restricts expense management to authenticated users.
     */
    match /expenses/{expenseId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Manages exports. Only authenticated users can manage exports.
     * @path: /exports/{exportId}
     * @allow: (create, get, list, update, delete) - Authenticated user can manage exports.
     * @deny: (create, get, list, update, delete) - Unauthenticated user tries to manage exports.
     * @principle: Restricts export management to authenticated users.
     */
    match /exports/{exportId} {
       // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    /**
     * @description: Restricts access to financial transactions. Only authenticated users can list.
     * @path: /financial_transactions
     * @allow: (list) - Authenticated user can list financial transactions.
     * @deny: (get, create, update, delete) - All operations are denied.
     * @principle: Restricts access to financial transactions.
     */
    match /financial_transactions/{document} {
         // Helper function to check if the user is signed in.
        function isSignedIn() {
          return request.auth != null;
        }
        allow get: if false;
        allow list: if isSignedIn();
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}