/**
 * @fileoverview Firestore Security Rules for HuskTrack system.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, with ownership for user profiles.
 * Admins have broad access, while managers and employees have restricted access.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles; access controlled by user ID.
 * - /clients/{clientId}: Stores client information; access controlled by role.
 * - /products/{productId}: Stores product information; access controlled by role.
 * - /stocks/{stockId}: Stores stock information; access controlled by role.
 * - /sales/{saleId}: Stores sales transaction data; access controlled by role.
 * - /purchases/{purchaseId}: Stores purchase data; access controlled by role.
 * - /receipts/{receiptId}: Stores receipt data; access controlled by role.
 * - /expenses/{expenseId}: Stores expense data; access controlled by role.
 * - /exports/{exportId}: Stores export data; access controlled by role.
 *
 * Key Security Decisions:
 * - Users can only manage their own profiles.
 * - Listing of financial transaction data is restricted based on role.
 * - Data validation is limited to authorization-critical fields.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the resource.
     * Ensures the document exists before checking ownership.
     */
    function isExistingOwner(userId) {
      return (isOwner(userId) && resource != null);
    }

    /**
     * @description Checks if the user has the 'Admin' role.
     */
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    /**
     * @description Checks if the user has the 'Manager' role.
     */
    function isManager() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Manager';
    }

    /**
     * @description Checks if the user has the 'Employee' role.
     */
    function isEmployee() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Employee';
    }

    /**
     * @description Security rules for /users/{userId} documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     *          request.auth.uid: 'user123', request.resource.data.id: 'user123'
     * @allow (get) User with ID 'user123' can retrieve their profile.
     *          request.auth.uid: 'user123'
     * @allow (update) User with ID 'user123' can update their profile.
     *          request.auth.uid: 'user123'
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     *         request.auth.uid: 'user456', request.resource.data.id: 'user123'
     * @deny (update) User with ID 'user456' cannot update the profile of 'user123'.
     *         request.auth.uid: 'user456'
     * @deny (delete) Non-owner cannot delete the profile.
     *         request.auth.uid: 'user456'
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for /clients/{clientId} documents.
     * @path /clients/{clientId}
     * @allow (create) Admin can create a new client.
     *          User.role: 'Admin'
     * @allow (get) Manager or Admin can retrieve client information.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update client information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new client.
     *          User.role: 'Employee'
     * @deny (update) Employee cannot update client information.
     *          User.role: 'Employee'
     * @deny (delete) Employee cannot delete client information.
     *          User.role: 'Employee'
     * @principle Restricts client management to authorized roles.
     */
    match /clients/{clientId} {
      allow get, list: if isManager() || isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /products/{productId} documents.
     * @path /products/{productId}
     * @allow (create) Admin can create a new product.
     *          User.role: 'Admin'
     * @allow (get) Any signed-in user can retrieve product information.
     *          isSignedIn(): true
     * @allow (update) Admin can update product information.
     *          User.role: 'Admin'
     * @deny (create) Manager cannot create a new product.
     *          User.role: 'Manager'
     * @deny (update) Manager cannot update product information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete product information.
     *          User.role: 'Manager'
     * @principle Restricts product management to admins, allows public read access.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /stocks/{stockId} documents.
     * @path /stocks/{stockId}
     * @allow (create) Admin can create a new stock entry.
     *          User.role: 'Admin'
     * @allow (get) Manager or Admin can retrieve stock information.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update stock information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new stock entry.
     *          User.role: 'Employee'
     * @deny (update) Employee cannot update stock information.
     *          User.role: 'Employee'
     * @deny (delete) Employee cannot delete stock information.
     *          User.role: 'Employee'
     * @principle Restricts stock management to authorized roles.
     */
    match /stocks/{stockId} {
      allow get, list: if isManager() || isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /sales/{saleId} documents.
     * @path /sales/{saleId}
     * @allow (create) Manager or Admin can create a new sale record.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (get) Employee, Manager, or Admin can retrieve sale information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update sale information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new sale record.
     *          User.role: 'Employee'
     * @deny (update) Manager cannot update sale information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete sale information.
     *          User.role: 'Manager'
     * @principle Restricts sale management to authorized roles.
     */
    match /sales/{saleId} {
      allow get, list: if isEmployee() || isManager() || isAdmin();
      allow create: if isManager() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /purchases/{purchaseId} documents.
     * @path /purchases/{purchaseId}
     * @allow (create) Manager or Admin can create a new purchase record.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (get) Employee, Manager, or Admin can retrieve purchase information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update purchase information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new purchase record.
     *          User.role: 'Employee'
     * @deny (update) Manager cannot update purchase information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete purchase information.
     *          User.role: 'Manager'
     * @principle Restricts purchase management to authorized roles.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isEmployee() || isManager() || isAdmin();
      allow create: if isManager() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /receipts/{receiptId} documents.
     * @path /receipts/{receiptId}
     * @allow (create) Manager or Admin can create a new receipt.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (get) Employee, Manager, or Admin can retrieve receipt information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update receipt information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new receipt.
     *          User.role: 'Employee'
     * @deny (update) Manager cannot update receipt information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete receipt information.
     *          User.role: 'Manager'
     * @principle Restricts receipt management to authorized roles.
     */
    match /receipts/{receiptId} {
      allow get, list: if isEmployee() || isManager() || isAdmin();
      allow create: if isManager() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /expenses/{expenseId} documents.
     * @path /expenses/{expenseId}
     * @allow (create) Manager or Admin can create a new expense record.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (get) Employee, Manager, or Admin can retrieve expense information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update expense information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new expense record.
     *          User.role: 'Employee'
     * @deny (update) Manager cannot update expense information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete expense information.
     *          User.role: 'Manager'
     * @principle Restricts expense management to authorized roles.
     */
    match /expenses/{expenseId} {
      allow get, list: if isEmployee() || isManager() || isAdmin();
      allow create: if isManager() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for /exports/{exportId} documents.
     * @path /exports/{exportId}
     * @allow (create) Manager or Admin can create a new export record.
     *          User.role: 'Manager' or User.role: 'Admin'
     * @allow (get) Employee, Manager, or Admin can retrieve export information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update export information.
     *          User.role: 'Admin'
     * @deny (create) Employee cannot create a new export record.
     *          User.role: 'Employee'
     * @deny (update) Manager cannot update export information.
     *          User.role: 'Manager'
     * @deny (delete) Manager cannot delete export information.
     *          User.role: 'Manager'
     * @principle Restricts export management to authorized roles.
     */
    match /exports/{exportId} {
      allow get, list: if isEmployee() || isManager() || isAdmin();
      allow create: if isManager() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

        /**
     * @description Security rules for /financial_transactions documents.
     * @path /financial_transactions
     * @allow (get) Employee, Manager, or Admin can retrieve financial_transactions information.
     *          User.role: 'Employee' or User.role: 'Manager' or User.role: 'Admin'
     * @allow (update) Admin can update financial_transactions information.
     *          User.role: 'Admin'
     *  @deny (create) Anyone cannot create a financial_transactions
     *
     *  @deny (delete) Anyone cannot delete a financial_transactions
     * @principle Restricts financial_transactions to authorized roles.
     */
     match /financial_transactions {
        allow get, list: if isEmployee() || isManager() || isAdmin();
        allow create: if false;
        allow update: if isAdmin();
        allow delete: if false;
     }
  }
}