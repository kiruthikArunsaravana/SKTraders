/**
 * @fileoverview Firestore Security Rules for SK Traders application.
 *
 * Core Philosophy:
 * This ruleset prioritizes simplicity by deferring role-based access control (RBAC) to the backend Spring Security implementation.
 * All authenticated users have broad read and write access to all data.
 *
 * Data Structure:
 * The Firestore database consists of several top-level collections:
 * - /clients/{clientId}
 * - /products/{productId}
 * - /stocks/{stockId}
 * - /sales/{saleId}
 * - /purchases/{purchaseId}
 * - /receipts/{receiptId}
 * - /expenses/{expenseId}
 * - /exports/{exportId}
 *
 * Key Security Decisions:
 * - Role-Based Access Control: RBAC is handled on the backend. These rules primarily focus on authentication and existence checks for updates and deletes.
 * - No User Listing: Listing all users is implicitly disallowed as there is no /users collection.
 * - No Authorization Denormalization: All role checks are performed on the server side, avoiding the need to duplicate authorization data within Firestore documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to read, create, update, and delete client information.
     * @path /clients/{clientId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage client data.
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete product information.
     * @path /products/{productId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage product data.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete stock information.
     * @path /stocks/{stockId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage stock data.
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete sale information.
     * @path /sales/{saleId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage sale data.
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete purchase information.
     * @path /purchases/{purchaseId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage purchase data.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete receipt information.
     * @path /receipts/{receiptId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage receipt data.
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete expense information.
     * @path /expenses/{expenseId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage expense data.
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read, create, update, and delete export information.
     * @path /exports/{exportId}
     * @allow (get, list) User is authenticated.
     * @allow (create, update, delete) User is authenticated.
     * @deny (create, update, delete) User is not authenticated.
     * @principle Authenticated users can manage export data.
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows any authenticated user to read financial transaction information.
     * @path /financial_transactions
     * @allow (get, list) User is authenticated.
     * @deny (create, update, delete) No write access allowed.
     * @principle Authenticated users can read financial transaction data.
     */
    match /financial_transactions {
        allow get, list: if isSignedIn();
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }

  // Helper function to check if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }
}