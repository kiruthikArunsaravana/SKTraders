/**
 * @description This ruleset enforces a role-based access control model for the HuskTrack system.
 * All data is stored in top-level collections with document IDs generated by the client.
 * Access is granted based on the authenticated user's role and, where applicable, ownership of the data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles with a 'role' field.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sales transaction data.
 * - /purchases/{purchaseId}: Stores purchase transactions.
 * - /receipts/{receiptId}: Stores receipt data.
 * - /expenses/{expenseId}: Stores expense data.
 * - /exports/{exportId}: Stores export data.
 * - /local_sales/{localSaleId}: Stores local sale data.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user documents.
 * - Clients, Products, Stocks, Sales, Purchases, Receipts, Expenses, Exports and LocalSales are accessible for all users.
 * - All `list` operations are allowed.
 * - All write operations are allowed.
 *
 * Denormalization for Authorization:
 * - User roles are denormalized directly into the /users/{userId} document to avoid extra reads during authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user document.
     * @path /users/{userId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete client data.
     * @path /clients/{clientId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete product data.
     * @path /products/{productId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete stock data.
     * @path /stocks/{stockId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete sale data.
     * @path /sales/{saleId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete purchase data.
     * @path /purchases/{purchaseId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete receipt data.
     * @path /receipts/{receiptId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete expense data.
     * @path /expenses/{expenseId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete export data.
     * @path /exports/{exportId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows all users to read, create, update, and delete local sale data.
     * @path /local_sales/{localSaleId}
     * @allow (get, list, create, update, delete) if isSignedIn()
     */
    match /local_sales/{localSaleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Checks if the user is signed in.
     * @return True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}