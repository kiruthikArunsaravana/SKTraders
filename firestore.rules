/**
 * @fileoverview Firestore Security Rules for HuskTrack application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, with a strict user-ownership model for user profiles and role-based restrictions on other collections.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sales transaction data.
 * - /purchases/{purchaseId}: Stores purchase transaction data.
 * - /receipts/{receiptId}: Stores receipt data.
 * - /expenses/{expenseId}: Stores expense data.
 * - /exports/{exportId}: Stores export data.
 * - /local_sales/{localSaleId}: Stores local sale data.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user documents.
 * - Listing of the `/users` collection is disallowed.
 * - All other collections are open for listing.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own user profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a document at /users/user123 if request.auth.uid == 'user123'.
     * @allow (get,update,delete) - User with UID 'user123' can get, update, or delete the document at /users/user123 if request.auth.uid == 'user123'.
     * @deny (create) - User with UID 'user456' cannot create a document at /users/user123.
     * @deny (update) - User with UID 'user456' cannot update the document at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows read and write access to client documents.
     * @path /clients/{clientId}
     * @allow (get,list) - Any signed-in user can read client data.
     * @allow (create,update,delete) - No one can create, update or delete a client
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to client data is allowed
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to product documents.
     * @path /products/{productId}
     * @allow (get,list) - Any signed-in user can read product data.
     * @allow (create,update,delete) - No one can create, update or delete a product
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to product data is allowed
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to stock documents.
     * @path /stocks/{stockId}
     * @allow (get,list) - Any signed-in user can read stock data.
     * @allow (create,update,delete) - No one can create, update or delete a stock
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to stock data is allowed
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to sales documents.
     * @path /sales/{saleId}
     * @allow (get,list) - Any signed-in user can read sales data.
     * @allow (create,update,delete) - No one can create, update or delete a sale
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to sales data is allowed
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to purchase documents.
     * @path /purchases/{purchaseId}
     * @allow (get,list) - Any signed-in user can read purchase data.
     * @allow (create,update,delete) - No one can create, update or delete a purchase
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to purchase data is allowed
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to receipt documents.
     * @path /receipts/{receiptId}
     * @allow (get,list) - Any signed-in user can read receipt data.
     * @allow (create,update,delete) - No one can create, update or delete a receipt
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to receipt data is allowed
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to expense documents.
     * @path /expenses/{expenseId}
     * @allow (get,list) - Any signed-in user can read expense data.
     * @allow (create,update,delete) - No one can create, update or delete a expense
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to expense data is allowed
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to export documents.
     * @path /exports/{exportId}
     * @allow (get,list) - Any signed-in user can read export data.
     * @allow (create,update,delete) - No one can create, update or delete a export
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to export data is allowed
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows read and write access to local_sales documents.
     * @path /local_sales/{localSaleId}
     * @allow (get,list) - Any signed-in user can read local_sales data.
     * @allow (create,update,delete) - No one can create, update or delete a local_sales
     * @deny (create) - Not allowed
     * @deny (update) - Not allowed
     * @principle Access to local_sales data is allowed
     */
    match /local_sales/{localSaleId} {
      allow get, list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}