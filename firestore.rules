/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and an role-based model for other data like clients, products, sales, purchases, reciepts, expenses and exports.
 * @dataStructure
 *   - /users/{userId}: Stores individual user profiles, accessible only by the user themselves or an admin.
 *   - /clients/{clientId}: Stores client data, accessible by admins, managers, and employees.
 *   - /products/{productId}: Stores product data, accessible by admins, managers, and employees.
 *   - /stocks/{stockId}: Stores stock data, accessible by admins and managers.
 *   - /sales/{saleId}: Stores sales data, accessible by admins, managers, and employees.
 *   - /purchases/{purchaseId}: Stores purchases data, accessible by admins, managers, and employees.
 *   - /receipts/{receiptId}: Stores receipts data, accessible by admins, managers, and employees.
 *   - /expenses/{expenseId}: Stores expense data, accessible only by admins.
 *   - /exports/{exportId}: Stores export data, accessible by admins, managers, and employees.
 *   - /roles_admin/{userId}: Documents in this collection denote admin role. Existence of the document confers admin access. No content is necessary.
 * @keySecurityDecisions
 *   - Strict user-ownership for profiles: Only the authenticated user can access their own profile data.
 *   - Role-based access for other data: Access to client, product, sales, purchase, receipt, and export data is granted to admins, managers, and employees. Access to expense data is restricted to admins only.
 *   - No user listing: Listing all users is disallowed to protect user privacy.
 *   - Denormalization for Authorization: The role of the user making the request is checked in the rules to grant or deny access to the other collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' creates their own profile. `request.auth.uid == 'user123'` and `request.resource.data.id == 'user123'`.
     * @allow (get, update, delete) - User with ID 'user123' reads their own profile. `request.auth.uid == 'user123'`.
     * @deny (create) - User with ID 'user123' attempts to create a profile with a different ID. `request.auth.uid == 'user123'` and `request.resource.data.id == 'user456'`.
     * @deny (get, update, delete) - User with ID 'user456' attempts to read the profile of user 'user123'. `request.auth.uid == 'user456'`.
     * @principle Enforces document ownership for reads and writes; validates relational integrity on create and update.
     */
    match /users/{userId} {
      // Helper function to check if the current user is the owner of the document
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the current user is the owner of the document and the document exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to client data.
     * @path /clients/{clientId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all client data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access client data.
     * @principle Restricts access based on user role.
     */
    match /clients/{clientId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to product data.
     * @path /products/{productId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all product data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access product data.
     * @principle Restricts access based on user role.
     */
    match /products/{productId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to stock data.
     * @path /stocks/{stockId}
     * @allow (get, list, create, update, delete) - User with role 'Admin' or 'Manager' can access all stock data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access stock data.
     * @principle Restricts access based on user role.
     */
    match /stocks/{stockId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to sales data.
     * @path /sales/{saleId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all sales data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access sales data.
     * @principle Restricts access based on user role.
     */
    match /sales/{saleId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to purchase data.
     * @path /purchases/{purchaseId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all purchase data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access purchase data.
     * @principle Restricts access based on user role.
     */
    match /purchases/{purchaseId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to receipt data.
     * @path /receipts/{receiptId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all receipt data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access receipt data.
     * @principle Restricts access based on user role.
     */
    match /receipts/{receiptId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

    /**
     * @description Controls access to expense data.
     * @path /expenses/{expenseId}
     * @allow (get, list, create, update, delete) - User with role 'Admin' can access all expense data.
     * @deny (get, list, create, update, delete) - User without 'Admin' role attempts to access expense data.
     * @principle Restricts access based on user role.
     */
    match /expenses/{expenseId} {
      // Helper function to check if the user has the Admin role
      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Controls access to export data.
     * @path /exports/{exportId}
     * @allow (get, list, create, update, delete) - User with role 'Admin', 'Manager', or 'Employee' can access all export data.
     * @deny (get, list, create, update, delete) - User without a valid role attempts to access export data.
     * @principle Restricts access based on user role.
     */
    match /exports/{exportId} {
      // Helper function to check if the user has the required role
      function hasRequiredRole() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get, list: if hasRequiredRole();
      allow create: if hasRequiredRole();
      allow update: if hasRequiredRole() && resource != null;
      allow delete: if hasRequiredRole() && resource != null;
    }

       /**
        * @description Controls access to admin role data.  The existence of a document indicates that the user is an admin.
        * @path /roles_admin/{userId}
        * @allow (create) - User with ID 'user123' creates their own profile. `request.auth.uid == 'user123'`.
        * @allow (get, update, delete) - User with ID 'user123' reads their own profile. `request.auth.uid == 'user123'`.
        * @deny (create) - User with ID 'user123' attempts to create a profile with a different ID. `request.auth.uid == 'user123'` and `request.resource.data.id == 'user456'`.
        * @deny (get, update, delete) - User with ID 'user456' attempts to read the profile of user 'user123'. `request.auth.uid == 'user456'`.
        */
    match /roles_admin/{userId}{
            function isOwner(userId) {
                return request.auth.uid == userId;
              }
      
              // Helper function to check if the current user is the owner of the document and the document exists
              function isExistingOwner(userId) {
                return isOwner(userId) && resource != null;
              }
                allow get: if isOwner(userId);
                allow list: if false;
                allow create: if isOwner(userId);
                allow update: if isExistingOwner(userId);
                allow delete: if isExistingOwner(userId);
            }
  }
}