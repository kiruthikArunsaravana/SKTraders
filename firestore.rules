/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a default-deny security model, requiring explicit authorization for all data access.
 *
 * Data Structure:
 * - Top-level collections like 'financial_transactions' are secured with public read and owner-only write access.
 *
 * Key Security Decisions:
 * - All write operations require a verified, signed-in user.
 * - Read operations on 'financial_transactions' are public.
 * - Write operations on 'financial_transactions' are restricted to the document owner, as determined by the 'ownerId' field.
 * - Listing of collections is generally allowed for owners of user-scoped subcollections, unless explicitly denied.
 *
 * Denormalization for Authorization:
 * - The 'financial_transactions' collection requires an 'ownerId' field on each document to enforce write access.
 *   The rules validate that the 'ownerId' matches the authenticated user's UID on create, update, and delete operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to the 'financial_transactions' collection and restricts write access to the owner of each document.
     * @path /databases/{database}/documents/financial_transactions
     * @allow (get, list): Any user can read the documents in this collection.
     * @allow (create): Only the user with UID matching request.auth.uid can create a document, setting the 'ownerId' field to their UID.
     * @allow (update, delete): Only the user with UID matching the 'ownerId' field of the existing document can update or delete it.
     * @deny (create): A user attempts to create a 'financial_transactions' document but does not set the 'ownerId' to their UID.
     * @deny (update, delete): A user attempts to update or delete a 'financial_transactions' document that they do not own (their UID does not match the 'ownerId' field).
     * @principle Enforces public read access with owner-only write access for the 'financial_transactions' collection.
     */
    match /financial_transactions/{transactionId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.ownerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.ownerId);
    }

    // Define helper functions for reusability and readability
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}