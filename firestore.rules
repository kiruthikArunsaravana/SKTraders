/**
 * @fileoverview Firestore Security Rules for HuskTrack - SK Traders Management System.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control model. Users have roles (Admin, Manager, Employee),
 * and access is granted based on these roles. User data is stored under /users/{userId}, and other
 * collections are accessible based on the user's role.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the 'role' field denormalized for authorization.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sales transaction data.
 * - /purchases/{purchaseId}: Stores purchase transaction data.
 * - /receipts/{receiptId}: Stores receipt data.
 * - /expenses/{expenseId}: Stores expense data.
 * - /exports/{exportId}: Stores export data.
 *
 * Key Security Decisions:
 * - Users can only read and write their own /users/{userId} document.
 * - Only users with the 'Admin' role can create, update, or delete products.
 * - Access to clients, stocks, sales, purchases, receipts, expenses, and exports is role-based,
 *   allowing 'Manager' and 'Admin' roles to manage the data.
 *
 * Denormalization for Authorization:
 * - User roles are stored directly in the /users/{userId} document to avoid extra reads during
 *   authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) Authenticated user can get, update and delete their own profile if the userId matches their auth.uid.
     * @allow (list) Denied to prevent listing all users.
     * @deny (create) An unauthenticated user cannot create a user profile.
     * @deny (update, delete) A user cannot update or delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to client data.
     * @path /clients/{clientId}
     * @allow (get, list) Allows all authenticated users to get and list client data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete client data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify client data.
     * @principle Enforces role-based access control for client data management.
     */
    match /clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to product data.
     * @path /products/{productId}
     * @allow (get, list) Allows all authenticated users to get and list product data.
     * @allow (create, update, delete) Only allows users with the 'Admin' role to create, update, or delete product data.
     * @deny (create, update, delete) Denies users without 'Admin' role to modify product data.
     * @principle Enforces role-based access control for product data management.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Controls access to stock data.
     * @path /stocks/{stockId}
     * @allow (get, list) Allows all authenticated users to get and list stock data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete stock data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify stock data.
     * @principle Enforces role-based access control for stock data management.
     */
    match /stocks/{stockId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to sales data.
     * @path /sales/{saleId}
     * @allow (get, list) Allows all authenticated users to get and list sales data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete sales data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify sales data.
     * @principle Enforces role-based access control for sales data management.
     */
    match /sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to purchase data.
     * @path /purchases/{purchaseId}
     * @allow (get, list) Allows all authenticated users to get and list purchase data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete purchase data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify purchase data.
     * @principle Enforces role-based access control for purchase data management.
     */
    match /purchases/{purchaseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to receipt data.
     * @path /receipts/{receiptId}
     * @allow (get, list) Allows all authenticated users to get and list receipt data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete receipt data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify receipt data.
     * @principle Enforces role-based access control for receipt data management.
     */
    match /receipts/{receiptId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to expense data.
     * @path /expenses/{expenseId}
     * @allow (get, list) Allows all authenticated users to get and list expense data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete expense data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify expense data.
     * @principle Enforces role-based access control for expense data management.
     */
    match /expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Controls access to export data.
     * @path /exports/{exportId}
     * @allow (get, list) Allows all authenticated users to get and list export data.
     * @allow (create, update, delete) Only allows users with the 'Admin' or 'Manager' role to create, update, or delete export data.
     * @deny (create, update, delete) Denies users without 'Admin' or 'Manager' role to modify export data.
     * @principle Enforces role-based access control for export data management.
     */
    match /exports/{exportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }
  }
}