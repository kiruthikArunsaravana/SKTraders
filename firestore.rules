/**
 * @fileoverview Firestore Security Rules for HuskTrack application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, granting specific
 * permissions based on the user's role (Admin, Manager, Employee). The system
 * emphasizes authorization independence through denormalization. Data validation
 * is relaxed for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. User documents are secured using
 *   owner-only access.
 * - /clients/{clientId}: Stores client information. Access is restricted to
 *   authorized users.
 * - /products/{productId}: Stores product information. Access is restricted to
 *   authorized users.
 * - /stocks/{stockId}: Stores stock information. Access is restricted to
 *   authorized users.
 * - /sales/{saleId}: Stores sale transaction. Access is restricted to
 *   authorized users.
 * - /purchases/{purchaseId}: Stores purchase transaction. Access is
 *   restricted to authorized users.
 * - /receipts/{receiptId}: Stores receipt data. Access is restricted to
 *   authorized users.
 * - /expenses/{expenseId}: Stores expense data. Access is restricted to
 *   authorized users.
 * - /exports/{exportId}: Stores export data. Access is restricted to
 *   authorized users.
 * - /local_sales/{localSaleId}: Stores local sale data. Access is restricted
 *   to authorized users.
 * - /financial_transactions/{transactionId}: Stores financial transaction data.
 *   Access is restricted to authorized users.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Data validation is minimized for faster prototyping. Authorization is
 *   prioritized.
 * - The ruleset defaults to strict owner-only access where relationships are
 *   ambiguous.
 *
 * Denormalization for Authorization:
 * - User roles are denormalized into the /users/{userId} document to simplify
 *   role checks.
 *
 * Structural Segregation:
 * - User-specific data is segregated under /users/{userId} to simplify
 *   ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles, ensuring users can only access their own data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     * @allow (get, update, delete) Authenticated user 'user123' can get, update, or delete their profile.
     * @deny (get, update, delete) Authenticated user 'user456' cannot get, update, or delete 'user123' profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages client data, accessible to authorized users (e.g., Managers, Admins).
     * @path /clients/{clientId}
     * @allow (create) Authorized user can create a client document.
     * @deny (create) Unauthorized user cannot create a client document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete client documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete client documents.
     * @principle Restricts data access to authorized users.
     */
    match /clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages product data, accessible to authorized users (e.g., Admins).
     * @path /products/{productId}
     * @allow (create) Authorized user can create a product document.
     * @deny (create) Unauthorized user cannot create a product document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete product documents.
     * @deny (get, list, update, or delete) Unauthorized user cannot get, list, update, or delete product documents.
     * @principle Restricts data access to authorized users.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages stock data, accessible to authorized users (e.g., Managers, Admins).
     * @path /stocks/{stockId}
     * @allow (create) Authorized user can create a stock document.
     * @deny (create) Unauthorized user cannot create a stock document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete stock documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete stock documents.
     * @principle Restricts data access to authorized users.
     */
    match /stocks/{stockId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages sale data, accessible to authorized users (e.g., Managers, Admins).
     * @path /sales/{saleId}
     * @allow (create) Authorized user can create a sale document.
     * @deny (create) Unauthorized user cannot create a sale document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete sale documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete sale documents.
     * @principle Restricts data access to authorized users.
     */
    match /sales/{saleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages purchase data, accessible to authorized users (e.g., Managers, Admins).
     * @path /purchases/{purchaseId}
     * @allow (create) Authorized user can create a purchase document.
     * @deny (create) Unauthorized user cannot create a purchase document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete purchase documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete purchase documents.
     * @principle Restricts data access to authorized users.
     */
    match /purchases/{purchaseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages receipt data, accessible to authorized users (e.g., Managers, Admins).
     * @path /receipts/{receiptId}
     * @allow (create) Authorized user can create a receipt document.
     * @deny (create) Unauthorized user cannot create a receipt document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete receipt documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete receipt documents.
     * @principle Restricts data access to authorized users.
     */
    match /receipts/{receiptId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages expense data, accessible to authorized users (e.g., Managers, Admins).
     * @path /expenses/{expenseId}
     * @allow (create) Authorized user can create an expense document.
     * @deny (create) Unauthorized user cannot create an expense document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete expense documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete expense documents.
     * @principle Restricts data access to authorized users.
     */
    match /expenses/{expenseId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages export data, accessible to authorized users (e.g., Managers, Admins).
     * @path /exports/{exportId}
     * @allow (create) Authorized user can create an export document.
     * @deny (create) Unauthorized user cannot create an export document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete export documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete export documents.
     * @principle Restricts data access to authorized users.
     */
    match /exports/{exportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages local sale data, accessible to authorized users (e.g., Managers, Admins).
     * @path /local_sales/{localSaleId}
     * @allow (create) Authorized user can create a local sale document.
     * @deny (create) Unauthorized user cannot create a local sale document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete local sale documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete local sale documents.
     * @principle Restricts data access to authorized users.
     */
    match /local_sales/{localSaleId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages financial transaction data, accessible to authorized users (e.g., Managers, Admins).
     * @path /financial_transactions/{transactionId}
     * @allow (create) Authorized user can create a financial transaction document.
     * @deny (create) Unauthorized user cannot create a financial transaction document.
     * @allow (get, list, update, delete) Authorized user can get, list, update, or delete financial transaction documents.
     * @deny (get, list, update, delete) Unauthorized user cannot get, list, update, or delete financial transaction documents.
     * @principle Restricts data access to authorized users.
     */
    match /financial_transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // In a real application, roles would be validated here.  For prototyping, any signed-in user can access.
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }
}