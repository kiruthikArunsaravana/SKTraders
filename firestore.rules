/**
 * @description This ruleset enforces a strict role-based access control model for the HuskTrack system.
 * All write operations are protected by authorization checks. Data validation is limited to authorization-critical
 * fields to allow for rapid prototyping.
 * @dataStructure
 * - /users/{userId}: Stores user profiles with denormalized roles for authorization.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock levels for products.
 * - /sales/{saleId}: Stores sale transactions.
 * - /purchases/{purchaseId}: Stores purchase transactions.
 * - /receipts/{receiptId}: Stores receipts for sales and purchases.
 * - /expenses/{expenseId}: Stores expense records.
 * - /exports/{exportId}: Stores export order details.
 * - /local_sales/{localSaleId}: Stores local sale order details.
 * @keySecurityDecisions
 * - User listing is not explicitly denied, but is implicitly denied because there is no rule that allows it.
 * - The rules prioritize security and assume a strict posture unless explicitly opened.
 * @denormalizationForAuthorization
 * - User roles are denormalized into the /users/{userId} document to avoid costly get() calls during authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile data, ensuring users can only access their own profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile: request.auth.uid == 'user123'
     * @allow (get) User with ID 'user123' can read their profile: request.auth.uid == 'user123'
     * @allow (update) User with ID 'user123' can update their profile: request.auth.uid == 'user123'
     * @allow (delete) User with ID 'user123' can delete their profile: request.auth.uid == 'user123'
     * @deny (create) User with ID 'user123' cannot create a profile with ID 'user456': request.auth.uid != 'user456'
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is disallowed.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages client data, accessible only to authenticated users.
     * @path /clients/{clientId}
     * @allow (create) User can create a client: isSignedIn()
     * @allow (get) User can read a client: isSignedIn()
     * @allow (update) User can update a client: isSignedIn()
     * @allow (delete) User can delete a client: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a client: !isSignedIn()
     * @principle Requires authentication for all operations on client data.
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages product data, accessible only to authenticated users.
     * @path /products/{productId}
     * @allow (create) User can create a product: isSignedIn()
     * @allow (get) User can read a product: isSignedIn()
     * @allow (update) User can update a product: isSignedIn()
     * @allow (delete) User can delete a product: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a product: !isSignedIn()
     * @principle Requires authentication for all operations on product data.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages stock data, accessible only to authenticated users.
     * @path /stocks/{stockId}
     * @allow (create) User can create a stock entry: isSignedIn()
     * @allow (get) User can read a stock entry: isSignedIn()
     * @allow (update) User can update a stock entry: isSignedIn()
     * @allow (delete) User can delete a stock entry: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a stock entry: !isSignedIn()
     * @principle Requires authentication for all operations on stock data.
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages sale transaction data, accessible only to authenticated users.
     * @path /sales/{saleId}
     * @allow (create) User can create a sale: isSignedIn()
     * @allow (get) User can read a sale: isSignedIn()
     * @allow (update) User can update a sale: isSignedIn()
     * @allow (delete) User can delete a sale: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a sale: !isSignedIn()
     * @principle Requires authentication for all operations on sale data.
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages purchase transaction data, accessible only to authenticated users.
     * @path /purchases/{purchaseId}
     * @allow (create) User can create a purchase: isSignedIn()
     * @allow (get) User can read a purchase: isSignedIn()
     * @allow (update) User can update a purchase: isSignedIn()
     * @allow (delete) User can delete a purchase: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a purchase: !isSignedIn()
     * @principle Requires authentication for all operations on purchase data.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages receipt data, accessible only to authenticated users.
     * @path /receipts/{receiptId}
     * @allow (create) User can create a receipt: isSignedIn()
     * @allow (get) User can read a receipt: isSignedIn()
     * @allow (update) User can update a receipt: isSignedIn()
     * @allow (delete) User can delete a receipt: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a receipt: !isSignedIn()
     * @principle Requires authentication for all operations on receipt data.
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages expense data, accessible only to authenticated users.
     * @path /expenses/{expenseId}
     * @allow (create) User can create an expense: isSignedIn()
     * @allow (get) User can read an expense: isSignedIn()
     * @allow (update) User can update an expense: isSignedIn()
     * @allow (delete) User can delete an expense: isSignedIn()
     * @deny (create) Unauthenticated user cannot create an expense: !isSignedIn()
     * @principle Requires authentication for all operations on expense data.
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages export order data, accessible only to authenticated users.
     * @path /exports/{exportId}
     * @allow (create) User can create an export order: isSignedIn()
     * @allow (get) User can read an export order: isSignedIn()
     * @allow (update) User can update an export order: isSignedIn()
     * @allow (delete) User can delete an export order: isSignedIn()
     * @deny (create) Unauthenticated user cannot create an export order: !isSignedIn()
     * @principle Requires authentication for all operations on export data.
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages local sale order data, accessible only to authenticated users.
     * @path /local_sales/{localSaleId}
     * @allow (create) User can create a local sale order: isSignedIn()
     * @allow (get) User can read a local sale order: isSignedIn()
     * @allow (update) User can update a local sale order: isSignedIn()
     * @allow (delete) User can delete a local sale order: isSignedIn()
     * @deny (create) Unauthenticated user cannot create a local sale order: !isSignedIn()
     * @principle Requires authentication for all operations on local sale data.
     */
    match /local_sales/{localSaleId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    // ============================ HELPER FUNCTIONS ============================

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the document and the document exists.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}