/**
 * @fileoverview Firestore Security Rules for SK Traders.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control, with specific permissions granted to 'Admin', 'Manager', and 'Employee' roles.
 * User documents are self-owned for creation, and admins can manage all data. Other collections are generally accessible only to admins, or sometimes managers, depending on the entity.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with roles.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock levels.
 * - /sales/{saleId}: Stores sales transactions.
 * - /purchases/{purchaseId}: Stores purchase transactions.
 * - /receipts/{receiptId}: Stores receipts.
 * - /expenses/{expenseId}: Stores expenses.
 * - /exports/{exportId}: Stores export orders.
 * - /local_sales/{localSaleId}: Stores local sale orders.
 * - /financial_transactions/{transactionId}: Stores financial transactions.
 *
 * Key Security Decisions:
 * - Only authenticated users can access any data.
 * - User listing is disallowed for privacy.
 * - Each collection is secured based on role, as defined below.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Manages user profiles. Only the user themselves can create their profile. Admins can read and write all user data.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' creates their own profile.
     *   request.auth.uid == 'user123' && request.resource.data.id == 'user123'
     * @allow (get, update, delete) - Admin user 'admin456' can get, update, and delete any user profile.
     *   request.auth.uid == 'admin456' and hasRole('Admin')
     * @deny (create) - User 'user456' tries to create a profile for 'user789'.
     *   request.auth.uid == 'user456' && request.resource.data.id == 'user789'
     * @principle Enforces document ownership for creation and role-based access for other operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (isOwner(userId) || hasRole('Admin'));
      allow list: if false; // User listing is not permitted.
      allow create: if isSignedIn() && isOwner(userId) && request.auth.uid == userId;
      allow update: if isSignedIn() && (isOwner(userId) || hasRole('Admin'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages client information. Accessible only to Admins and Managers.
     * @path /clients/{clientId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all client data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access client data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts client data management to authorized roles.
     */
    match /clients/{clientId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages product information. Accessible only to Admins and Managers.
     * @path /products/{productId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all product data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access product data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts product data management to authorized roles.
     */
    match /products/{productId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages stock information. Accessible only to Admins and Managers.
     * @path /stocks/{stockId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all stock data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access stock data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts stock data management to authorized roles.
     */
    match /stocks/{stockId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages sales transactions. Accessible only to Admins and Managers.
     * @path /sales/{saleId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all sale data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access sale data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts sale data management to authorized roles.
     */
    match /sales/{saleId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages purchase transactions. Accessible only to Admins and Managers.
     * @path /purchases/{purchaseId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all purchase data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access purchase data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts purchase data management to authorized roles.
     */
    match /purchases/{purchaseId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages receipts. Accessible only to Admins and Managers.
     * @path /receipts/{receiptId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all receipt data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access receipt data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts receipt data management to authorized roles.
     */
    match /receipts/{receiptId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages expenses. Accessible only to Admins and Managers.
     * @path /expenses/{expenseId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all expense data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access expense data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts expense data management to authorized roles.
     */
    match /expenses/{expenseId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages export orders. Accessible only to Admins and Managers.
     * @path /exports/{exportId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all export data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access export data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts export data management to authorized roles.
     */
    match /exports/{exportId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }

    /**
     * @description Manages local sale orders. Accessible only to Admins and Managers.
     * @path /local_sales/{localSaleId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all local sale data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access local sale data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts local sale data management to authorized roles.
     */
    match /local_sales/{localSaleId} {
      function hasRole(role) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
      }

      allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
      allow delete: if isSignedIn() && hasRole('Admin');
    }
    /**
     * @description Manages financial transactions. Accessible only to Admins and Managers.
     * @path /financial_transactions/{transactionId}
     * @allow (create, get, list, update, delete) - Admin user 'admin456' can manage all financial transaction data.
     *   request.auth.uid == 'admin456' && hasRole('Admin')
     * @deny (create, get, list, update, delete) - Employee user 'employee789' cannot access financial transaction data.
     *   request.auth.uid == 'employee789' && hasRole('Employee')
     * @principle Restricts financial transaction data management to authorized roles.
     */
    match /financial_transactions/{transactionId} {
        function hasRole(role) {
            return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
        }


        allow get: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
        allow list: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
        allow create: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
        allow update: if isSignedIn() && (hasRole('Admin') || hasRole('Manager'));
        allow delete: if isSignedIn() && hasRole('Admin');
    }
  }
}