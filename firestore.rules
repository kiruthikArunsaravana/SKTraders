/**
 * @file Firebase Security Rules for HuskTrack Firestore database.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, where user roles (Admin, Manager, Employee) determine access to different collections and documents. The primary goal is to restrict data access based on the authenticated user's role, while allowing for flexible data shapes during this prototyping phase.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information. User's can only read and write their own profile.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sale transaction information.
 * - /purchases/{purchaseId}: Stores purchase transaction information.
 * - /receipts/{receiptId}: Stores receipt information.
 * - /expenses/{expenseId}: Stores expense information.
 * - /exports/{exportId}: Stores export information.
 *
 * Key Security Decisions:
 * - Only authenticated users can access the database.
 * - User roles are denormalized into the user document to simplify authorization checks.
 * - Data validation is limited to authorization-critical fields to allow for rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own user document if the userId matches their auth UID.
     * @allow (get, list, update, delete) - Authenticated user can only get, update, or delete their own user document.
     * @deny (create) - An unauthenticated user cannot create a user document.
     * @deny (update, delete) - An authenticated user cannot update or delete another user's document.
     * @principle Enforces document ownership and prevents unauthorized modification of user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to client documents.
     * @path /clients/{clientId}
     * @allow (get, list) - Any authenticated user can read client documents.
     * @allow (create) - Any authenticated user can create client documents.
     * @allow (update) - Any authenticated user can update client documents.
     * @allow (delete) - Any authenticated user can delete client documents.
     * @deny (create) - An unauthenticated user cannot create a client document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to product documents.
     * @path /products/{productId}
     * @allow (get, list) - Any authenticated user can read product documents.
     * @allow (create) - Any authenticated user can create product documents.
     * @allow (update) - Any authenticated user can update product documents.
     * @allow (delete) - Any authenticated user can delete product documents.
     * @deny (create) - An unauthenticated user cannot create a product document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to stock documents.
     * @path /stocks/{stockId}
     * @allow (get, list) - Any authenticated user can read stock documents.
     * @allow (create) - Any authenticated user can create stock documents.
     * @allow (update) - Any authenticated user can update stock documents.
     * @allow (delete) - Any authenticated user can delete stock documents.
     * @deny (create) - An unauthenticated user cannot create a stock document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to sale documents.
     * @path /sales/{saleId}
     * @allow (get, list) - Any authenticated user can read sale documents.
     * @allow (create) - Any authenticated user can create sale documents.
     * @allow (update) - Any authenticated user can update sale documents.
     * @allow (delete) - Any authenticated user can delete sale documents.
     * @deny (create) - An unauthenticated user cannot create a sale document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to purchase documents.
     * @path /purchases/{purchaseId}
     * @allow (get, list) - Any authenticated user can read purchase documents.
     * @allow (create) - Any authenticated user can create purchase documents.
     * @allow (update) - Any authenticated user can update purchase documents.
     * @allow (delete) - Any authenticated user can delete purchase documents.
     * @deny (create) - An unauthenticated user cannot create a purchase document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to receipt documents.
     * @path /receipts/{receiptId}
     * @allow (get, list) - Any authenticated user can read receipt documents.
     * @allow (create) - Any authenticated user can create receipt documents.
     * @allow (update) - Any authenticated user can update receipt documents.
     * @allow (delete) - Any authenticated user can delete receipt documents.
     * @deny (create) - An unauthenticated user cannot create a receipt document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to expense documents.
     * @path /expenses/{expenseId}
     * @allow (get, list) - Any authenticated user can read expense documents.
     * @allow (create) - Any authenticated user can create expense documents.
     * @allow (update) - Any authenticated user can update expense documents.
     * @allow (delete) - Any authenticated user can delete expense documents.
     * @deny (create) - An unauthenticated user cannot create a expense document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to export documents.
     * @path /exports/{exportId}
     * @allow (get, list) - Any authenticated user can read export documents.
     * @allow (create) - Any authenticated user can create export documents.
     * @allow (update) - Any authenticated user can update export documents.
     * @allow (delete) - Any authenticated user can delete export documents.
     * @deny (create) - An unauthenticated user cannot create a export document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to financial transaction documents.
     * @path /financial_transactions/{transactionId}
     * @allow (get, list) - Any authenticated user can read financial transaction documents.
     * @allow (create) - Any authenticated user can create financial transaction documents.
     * @allow (update) - Any authenticated user can update financial transaction documents.
     * @allow (delete) - Any authenticated user can delete financial transaction documents.
     * @deny (create) - An unauthenticated user cannot create a financial transaction document.
     * @deny (update, delete) - An unauthenticated user cannot update or delete another user's document.
     */
      match /financial_transactions/{transactionId} {
          allow get, list: if isSignedIn();
          allow create, update, delete: if isSignedIn();
      }
  }
}