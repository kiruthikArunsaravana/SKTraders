/**
 * @fileoverview Firestore Security Rules for SK Traders Application
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with user-ownership for user profiles.
 * It allows public read access to certain collections while restricting writes to authorized users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, secured with ownership.
 * - /clients/{clientId}: Stores client information.
 * - /products/{productId}: Stores product information.
 * - /stocks/{stockId}: Stores stock information.
 * - /sales/{saleId}: Stores sales transaction data.
 * - /purchases/{purchaseId}: Stores purchase transaction data.
 * - /receipts/{receiptId}: Stores receipt data.
 * - /expenses/{expenseId}: Stores expense data.
 * - /exports/{exportId}: Stores export data.
 * - /local_sales/{localSaleId}: Stores local sale data.
 * - /financial_transactions/{transactionId}: Stores financial transaction data.
 *
 * Key Security Decisions:
 * - User profiles are private and only accessible to the owning user.
 * - Public read access is enabled for product-related collections to facilitate product discovery.
 * - Data validation is relaxed to allow for rapid prototyping and schema iteration.
 *
 * Access Control Patterns:
 * - Ownership: /users/{userId}
 * - Public Read with Owner-Only Writes: /products/{productId}, /clients/{clientId}, /stocks/{stockId}, /sales/{saleId}, /purchases/{purchaseId}, /receipts/{receiptId}, /expenses/{expenseId}, /exports/{exportId}, /local_sales/{localSaleId}, /financial_transactions/{transactionId}
 *
 * Denormalization for Authorization:
 * - The 'role' field is denormalized into the /users/{userId} document to simplify authorization checks without requiring additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles. Only the user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile if authenticated as 'user123'.
     * @deny (create) User with ID 'user456' cannot create profile for 'user123'.
     * @allow (get) User 'user123' can read their own profile.
     * @deny (get) User 'user456' cannot read profile of 'user123'.
     * @allow (update) User 'user123' can update their own profile.
     * @deny (update) User 'user456' cannot update profile of 'user123'.
     * @allow (delete) User 'user123' can delete their own profile.
     * @deny (delete) User 'user456' cannot delete profile of 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages client information. Allows public reads, restricts writes to authorized users.
     * @path /clients/{clientId}
     * @allow (get) Any user can read client data.
     * @allow (list) Any user can list client data.
     * @allow (create) Authenticated user can create a client.
     * @deny (create) Unauthenticated user cannot create a client.
     * @allow (update) Authenticated user can update a client if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a client.
     * @allow (delete) Authenticated user can delete a client if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a client.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /clients/{clientId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages product information. Allows public reads, restricts writes to authorized users.
     * @path /products/{productId}
     * @allow (get) Any user can read product data.
     * @allow (list) Any user can list product data.
     * @allow (create) Authenticated user can create a product.
     * @deny (create) Unauthenticated user cannot create a product.
     * @allow (update) Authenticated user can update a product if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a product.
     * @allow (delete) Authenticated user can delete a product if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a product.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages stock information. Allows public reads, restricts writes to authorized users.
     * @path /stocks/{stockId}
     * @allow (get) Any user can read stock data.
     * @allow (list) Any user can list stock data.
     * @allow (create) Authenticated user can create a stock.
     * @deny (create) Unauthenticated user cannot create a stock.
     * @allow (update) Authenticated user can update a stock if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a stock.
     * @allow (delete) Authenticated user can delete a stock if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a stock.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /stocks/{stockId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages sales transactions. Allows public reads, restricts writes to authorized users.
     * @path /sales/{saleId}
     * @allow (get) Any user can read sale data.
     * @allow (list) Any user can list sale data.
     * @allow (create) Authenticated user can create a sale.
     * @deny (create) Unauthenticated user cannot create a sale.
     * @allow (update) Authenticated user can update a sale if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a sale.
     * @allow (delete) Authenticated user can delete a sale if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a sale.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /sales/{saleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages purchase transactions. Allows public reads, restricts writes to authorized users.
     * @path /purchases/{purchaseId}
     * @allow (get) Any user can read purchase data.
     * @allow (list) Any user can list purchase data.
     * @allow (create) Authenticated user can create a purchase.
     * @deny (create) Unauthenticated user cannot create a purchase.
     * @allow (update) Authenticated user can update a purchase if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a purchase.
     * @allow (delete) Authenticated user can delete a purchase if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a purchase.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /purchases/{purchaseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages receipts. Allows public reads, restricts writes to authorized users.
     * @path /receipts/{receiptId}
     * @allow (get) Any user can read receipt data.
     * @allow (list) Any user can list receipt data.
     * @allow (create) Authenticated user can create a receipt.
     * @deny (create) Unauthenticated user cannot create a receipt.
     * @allow (update) Authenticated user can update a receipt if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a receipt.
     * @allow (delete) Authenticated user can delete a receipt if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a receipt.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /receipts/{receiptId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages expenses. Allows public reads, restricts writes to authorized users.
     * @path /expenses/{expenseId}
     * @allow (get) Any user can read expense data.
     * @allow (list) Any user can list expense data.
     * @allow (create) Authenticated user can create an expense.
     * @deny (create) Unauthenticated user cannot create an expense.
     * @allow (update) Authenticated user can update an expense if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update an expense.
     * @allow (delete) Authenticated user can delete an expense if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete an expense.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /expenses/{expenseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages export orders. Allows public reads, restricts writes to authorized users.
     * @path /exports/{exportId}
     * @allow (get) Any user can read export data.
     * @allow (list) Any user can list export data.
     * @allow (create) Authenticated user can create an export order.
     * @deny (create) Unauthenticated user cannot create an export order.
     * @allow (update) Authenticated user can update an export order if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update an export order.
     * @allow (delete) Authenticated user can delete an export order if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete an export order.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /exports/{exportId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages local sale orders. Allows public reads, restricts writes to authorized users.
     * @path /local_sales/{localSaleId}
     * @allow (get) Any user can read local sale data.
     * @allow (list) Any user can list local sale data.
     * @allow (create) Authenticated user can create a local sale order.
     * @deny (create) Unauthenticated user cannot create a local sale order.
     * @allow (update) Authenticated user can update a local sale order if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a local sale order.
     * @allow (delete) Authenticated user can delete a local sale order if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a local sale order.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /local_sales/{localSaleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

       /**
     * @description Manages financial transactions. Allows public reads, restricts writes to authorized users.
     * @path /financial_transactions/{transactionId}
     * @allow (get) Any user can read financial transaction data.
     * @allow (list) Any user can list financial transaction data.
     * @allow (create) Authenticated user can create a financial transaction.
     * @deny (create) Unauthenticated user cannot create a financial transaction.
     * @allow (update) Authenticated user can update a financial transaction if they are the owner (check must be added to schema).
     * @deny (update) Unauthenticated user cannot update a financial transaction.
     * @allow (delete) Authenticated user can delete a financial transaction if they are the owner (check must be added to schema).
     * @deny (delete) Unauthenticated user cannot delete a financial transaction.
     * @principle Allows public reads, restricts writes to owners.
     */
    match /financial_transactions/{transactionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

  }

  // Helper function to determine if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

    // Helper function to determine if the user is the existing owner of the document
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}