/**
 * @fileoverview Firestore Security Rules for HuskTrack application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model, granting specific
 * permissions based on the user's role (Admin, Manager, Employee). User data
 * is secured under `/users/{userId}` with strict ownership. Other collections
 * like `/clients`, `/products`, `/sales`, etc., are secured with role-based
 * restrictions, ensuring that only authorized users can create, read, update,
 * or delete data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles; access is restricted to the owner.
 * - /clients/{clientId}: Stores client information; access is role-based.
 * - /products/{productId}: Stores product information; access is role-based.
 * - /stocks/{stockId}: Stores stock information; access is role-based.
 * - /sales/{saleId}: Stores sale transaction; access is role-based.
 * - /purchases/{purchaseId}: Stores purchase transactions; access is role-based.
 * - /receipts/{receiptId}: Stores receipt data; access is role-based.
 * - /expenses/{expenseId}: Stores expense data; access is role-based.
 * - /exports/{exportId}: Stores export data; access is role-based.
 * - /local_sales/{localSaleId}: Stores local sale data; access is role-based.
 * - /financial_transactions/{transactionId}: Stores financial transactions; access is role-based.
 *
 * Key Security Decisions:
 * - Strict user-ownership for /users/{userId} documents.
 * - Role-based access control for all other collections.
 * - No public listing of any collections containing potentially sensitive data.
 * - Data validation during writes is limited to ownership and relational
 *   integrity to facilitate rapid prototyping.
 *
 * Denormalization for Authorization:
 * - User roles are stored directly within the /users/{userId} document, removing
 *   the need for additional reads during authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Users can only read and write their own profile.
     * @path /users/{userId}
     * @allow (create) - User can create their own profile if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - User can only access their own profile.
     * @deny (create) - If the userId does not match their auth.uid.
     * @deny (get, list, update, delete) - If the user is not signed in or the userId does not match their auth.uid.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description Secure client information. Requires user to be an Admin or Manager.
     * @path /clients/{clientId}
     * @allow (create) - User must be an Admin or Manager.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin or Manager.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for client data.
     */
    match /clients/{clientId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure product information. Requires user to be an Admin.
     * @path /products/{productId}
     * @allow (create) - User must be an Admin.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin.
     * @deny (create) - If user is not an Admin.
     * @deny (update, delete) - If user is not an Admin.
     * @principle Enforces role-based access control for product data.
     */
    match /products/{productId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Secure stock information. Requires user to be an Admin or Manager.
     * @path /stocks/{stockId}
     * @allow (create) - User must be an Admin or Manager.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin or Manager.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for stock data.
     */
    match /stocks/{stockId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure sale transactions. Requires user to be an Admin, Manager, or Employee.
     * @path /sales/{saleId}
     * @allow (create) - User must be an Admin, Manager, or Employee.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin, Manager, or Employee.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for sale data.
     */
    match /sales/{saleId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      function isEmployee() {
        return request.auth.token.role == 'Employee';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager() || isEmployee();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure purchase transactions. Requires user to be an Admin or Manager.
     * @path /purchases/{purchaseId}
     * @allow (create) - User must be an Admin or Manager.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin or Manager.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for purchase data.
     */
    match /purchases/{purchaseId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure receipt data. Requires user to be an Admin, Manager, or Employee.
     * @path /receipts/{receiptId}
     * @allow (create) - User must be an Admin, Manager, or Employee.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin, Manager, or Employee.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for receipt data.
     */
    match /receipts/{receiptId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      function isEmployee() {
        return request.auth.token.role == 'Employee';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager() || isEmployee();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure expense data. Requires user to be an Admin or Manager.
     * @path /expenses/{expenseId}
     * @allow (create) - User must be an Admin or Manager.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin or Manager.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for expense data.
     */
    match /expenses/{expenseId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure export data. Requires user to be an Admin, Manager, or Employee.
     * @path /exports/{exportId}
     * @allow (create) - User must be an Admin, Manager, or Employee.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin, Manager, or Employee.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for export data.
     */
    match /exports/{exportId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      function isEmployee() {
        return request.auth.token.role == 'Employee';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager() || isEmployee();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure local sale data. Requires user to be an Admin, Manager, or Employee.
     * @path /local_sales/{localSaleId}
     * @allow (create) - User must be an Admin, Manager, or Employee.
     * @allow (get, list) - User can list or get if they are signed in
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin, Manager, or Employee.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for local sale data.
     */
    match /local_sales/{localSaleId} {
      function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }

      function isEmployee() {
        return request.auth.token.role == 'Employee';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager() || isEmployee();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }

    /**
     * @description Secure financial transaction data. Requires user to be an Admin or Manager.
     * @path /financial_transactions/{transactionId}
     * @allow (create) - User must be an Admin or Manager.
     * @allow (get, list) - User can list or get if they are signed in.
     * @allow (update, delete) - User must be an Admin or Manager.
     * @deny (create) - If user is not an Admin or Manager.
     * @deny (update, delete) - If user is not an Admin or Manager.
     * @principle Enforces role-based access control for financial transaction data.
     */
    match /financial_transactions/{transactionId} {
       function isAdmin() {
        return request.auth.token.role == 'Admin';
      }

      function isManager() {
        return request.auth.token.role == 'Manager';
      }
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isManager();
      allow update: if isAdmin() || isManager();
      allow delete: if isAdmin() || isManager();
    }
  }
}