/**
 * @fileoverview Firestore Security Rules for HuskTrack.
 *
 * Core Philosophy: This ruleset enforces a role-based access control model.
 *  Users can only manage their own profile data, while administrative roles
 *  (Admin, Manager) have broader access to business data.
 *
 * Data Structure:
 *  - /users/{userId}: Stores user profile information. Access is restricted to the owner.
 *  - /clients/{clientId}: Stores client information. Access is restricted to managers and admins.
 *  - /products/{productId}: Stores product information. Access is restricted to admins.
 *  - /stocks/{stockId}: Stores stock information. Access is restricted to managers and admins.
 *  - /sales/{saleId}: Stores sales transaction information. Access is restricted to managers and admins.
 *  - /purchases/{purchaseId}: Stores purchase transaction information. Access is restricted to managers and admins.
 *  - /receipts/{receiptId}: Stores receipt information. Access is restricted to managers and admins.
 *  - /expenses/{expenseId}: Stores expense information. Access is restricted to managers and admins.
 *  - /exports/{exportId}: Stores export information. Access is restricted to managers and admins.
 *  - /local_sales/{localSaleId}: Stores local sale information. Access is restricted to managers and admins.
 *  - /financial_transactions/{transactionId}: Stores financial transaction information. Access is restricted to managers and admins.
 *
 * Key Security Decisions:
 *  - Users can only create their own user document.
 *  - Users cannot list all users.
 *  - Write access to core business data (products, sales, purchases, etc.) is limited to privileged roles.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile data, enforcing owner-only access.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile.
     * @allow (get, update, delete) - Authenticated user can access/modify their own profile.
     * @deny (create) - If the user id doesnt match the authenticated user ID.
     * @deny (get, update, delete) - If the user id doesnt match the authenticated user ID.
     * @principle Enforces strict user ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // No listing of all users.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages client data, accessible to Managers and Admins.
     * @path /clients/{clientId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for client data.
     */
    match /clients/{clientId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages product data, accessible only to Admins.
     * @path /products/{productId}
     * @allow (get, list) - If the user is an Admin.
     * @allow (create, update, delete) - If the user is an Admin.
     * @deny (get, list, create, update, delete) - If the user is not an Admin.
     * @principle Role-based access control for product data.
     */
    match /products/{productId} {
      allow get, list: if isSignedIn() && isAdmin();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Manages stock data, accessible to Managers and Admins.
     * @path /stocks/{stockId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for stock data.
     */
    match /stocks/{stockId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages sales data, accessible to Managers and Admins.
     * @path /sales/{saleId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for sales data.
     */
    match /sales/{saleId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages purchase data, accessible to Managers and Admins.
     * @path /purchases/{purchaseId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for purchase data.
     */
    match /purchases/{purchaseId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages receipt data, accessible to Managers and Admins.
     * @path /receipts/{receiptId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for receipt data.
     */
    match /receipts/{receiptId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages expense data, accessible to Managers and Admins.
     * @path /expenses/{expenseId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for expense data.
     */
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages export data, accessible to Managers and Admins.
     * @path /exports/{exportId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for export data.
     */
    match /exports/{exportId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages local sale data, accessible to Managers and Admins.
     * @path /local_sales/{localSaleId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for local sale data.
     */
    match /local_sales/{localSaleId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

    /**
     * @description Manages financial transaction data, accessible to Managers and Admins.
     * @path /financial_transactions/{transactionId}
     * @allow (get, list) - If the user is an Admin or Manager.
     * @allow (create, update, delete) - If the user is an Admin or Manager.
     * @deny (get, list, create, update, delete) - If the user is not an Admin or Manager.
     * @principle Role-based access control for financial transaction data.
     */
    match /financial_transactions/{transactionId} {
      allow get, list: if isSignedIn() && (isAdmin() || isManager());
      allow create, update, delete: if isSignedIn() && (isAdmin() || isManager());
    }

  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

   // Helper function to determine if the user is an Admin
  function isAdmin() {
      return request.auth.token.role == 'Admin';
  }

  // Helper function to determine if the user is a Manager
  function isManager() {
      return request.auth.token.role == 'Manager';
  }
}